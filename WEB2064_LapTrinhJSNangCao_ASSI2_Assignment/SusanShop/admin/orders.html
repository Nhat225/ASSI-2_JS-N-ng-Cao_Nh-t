<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Susan Admin - Đơn hàng</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../styles/base.css"/>
  <link rel="stylesheet" href="../styles/phone-theme.css"/>
  <link rel="stylesheet" href="admin.css"/>
  <script type="module">
    import { requireAdmin } from '../js/auth.js';
    window.addEventListener('DOMContentLoaded', requireAdmin);
  </script>
</head>
<body class="admin-body">

<nav class="navbar navbar-expand-lg navbar-dark admin-navbar sticky-top py-3">
  <div class="container-fluid px-4">
    <a class="navbar-brand" href="index.html">Susan Admin</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-between" id="adminNav">
      <ul class="navbar-nav align-items-lg-center gap-lg-2">
        <li class="nav-item"><a class="nav-link" href="index.html">Bảng điều khiển</a></li>
        <li class="nav-item"><a class="nav-link" href="categories.html">Danh mục</a></li>
        <li class="nav-item"><a class="nav-link" href="products.html">Sản phẩm</a></li>
        <li class="nav-item"><a class="nav-link active" href="orders.html">Đơn hàng</a></li>
        <li class="nav-item"><a class="nav-link" href="users.html">Người dùng</a></li>
        <li class="nav-item"><a class="nav-link" href="stats.html">Báo cáo</a></li>
      </ul>
      <div class="d-flex align-items-center gap-2 mt-3 mt-lg-0">
        <a class="btn btn-sm btn-outline-light" href="../index.html">Xem website</a>
      </div>
    </div>
  </div>
</nav>

<main class="container-xl admin-shell">
  <header class="admin-hero">
    <span class="minimal-badge">Xử lý đơn</span>
    <h1 class="display-6 fw-semibold mt-3 mb-2">Theo dõi đơn hàng</h1>
    <p>Quản lý đơn mua mới, trạng thái thanh toán và lịch giao hàng.</p>
  </header>

  <section class="admin-card">
    <div class="admin-toolbar">
      <div>
        <h4 class="fw-semibold mb-1">Danh sách đơn hàng</h4>
        <p class="text-muted mb-0">Theo dõi các đơn gần nhất để xử lý nhanh chóng.</p>
      </div>
    </div>
    <div class="table-responsive admin-table">
      <div id="orders"></div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  import { OrderAPI } from '../js/api/orders.js';
  import { UserAPI } from '../js/api/users.js';
  import { fmtVND, toast } from '../js/utils.js';

  const wrap = document.getElementById('orders');
  const STATUS_LABELS = {
    pending: 'Chờ xử lý',
    completed: 'Hoàn thành',
    canceled: 'Đã hủy'
  };
  const STATUS_OPTIONS = Object.entries(STATUS_LABELS);
  let ordersState = [];
  let usersById = new Map();

  const formatDate = (value) => {
    if (!value) return '—';
    try {
      return new Date(value).toLocaleString('vi-VN', { dateStyle: 'short', timeStyle: 'short' });
    } catch {
      return value;
    }
  };

  const renderTable = () => {
    if (!ordersState.length) {
      wrap.innerHTML = '<div class="admin-empty">Chưa có đơn hàng nào.</div>';
      return;
    }

    const bodyRows = ordersState.map(order => {
      const customer = usersById.get(String(order.user_id));
      const customerName = customer?.name || `#${order.user_id}`;
      const customerEmail = customer?.email || '';
      const statusSelect = STATUS_OPTIONS.map(([value, label]) =>
        `<option value="${value}" ${order.status === value ? 'selected' : ''}>${label}</option>`
      ).join('');

      return `
        <tr data-id="${order.id}">
          <td class="text-nowrap">#${order.id}</td>
          <td>
            <div class="fw-semibold">${customerName}</div>
            ${customerEmail ? `<div class="text-muted small">${customerEmail}</div>` : ''}
          </td>
          <td class="text-nowrap">${formatDate(order.created_date)}</td>
          <td class="text-nowrap">
            <select class="form-select form-select-sm status-select" data-action="status" data-id="${order.id}">
              ${statusSelect}
            </select>
          </td>
          <td class="text-end">${fmtVND(order.total || 0)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-warning" data-action="delete" data-id="${order.id}">Xóa</button>
          </td>
        </tr>`;
    }).join('');

    wrap.innerHTML = `
      <table class="table table-dark align-middle table-hover mb-0 admin-orders-table">
        <thead>
          <tr>
            <th class="text-uppercase small text-muted">Mã đơn</th>
            <th class="text-uppercase small text-muted">Khách hàng</th>
            <th class="text-uppercase small text-muted">Ngày đặt</th>
            <th class="text-uppercase small text-muted">Trạng thái</th>
            <th class="text-uppercase small text-muted text-end">Tổng tiền</th>
            <th class="text-uppercase small text-muted text-end">Thao tác</th>
          </tr>
        </thead>
        <tbody>${bodyRows}</tbody>
      </table>`;

    wrap.querySelectorAll('[data-action="status"]').forEach(select => {
      select.addEventListener('change', async (event) => {
        const id = event.currentTarget.dataset.id;
        const newStatus = event.currentTarget.value;
        const order = ordersState.find(o => String(o.id) === String(id));
        if (!order) return;

        const previousStatus = order.status;
        event.currentTarget.disabled = true;
        try {
          const payload = { ...order, status: newStatus };
          await OrderAPI.update(order.id, payload);
          order.status = newStatus;
          toast('Đã cập nhật trạng thái đơn hàng');
        } catch (error) {
          order.status = previousStatus;
          event.currentTarget.value = previousStatus;
          toast('Không thể cập nhật trạng thái, vui lòng thử lại', 'error');
        } finally {
          event.currentTarget.disabled = false;
        }
      });
    });

    wrap.querySelectorAll('[data-action="delete"]').forEach(button => {
      button.addEventListener('click', async (event) => {
        const id = event.currentTarget.dataset.id;
        const order = ordersState.find(o => String(o.id) === String(id));
        if (!order) return;

        const confirmed = window.confirm(`Xóa đơn #${order.id}?`);
        if (!confirmed) return;

        event.currentTarget.disabled = true;
        try {
          await OrderAPI.remove(order.id);
          ordersState = ordersState.filter(o => String(o.id) !== String(order.id));
          toast('Đã xóa đơn hàng');
          renderTable();
        } catch (error) {
          toast('Không thể xóa đơn hàng, vui lòng thử lại', 'error');
          event.currentTarget.disabled = false;
        }
      });
    });
  };

  const loadOrders = async () => {
    try {
      const [orders, users] = await Promise.all([
        OrderAPI.list('_sort=created_date&_order=desc'),
        UserAPI.list()
      ]);
      ordersState = orders;
      usersById = new Map(users.map(user => [String(user.id), user]));
      renderTable();
    } catch (error) {
      wrap.innerHTML = '<div class="admin-empty text-danger">Không thể tải danh sách đơn hàng.</div>';
    }
  };

  await loadOrders();
</script>
</body>
</html>